# app.py
"""
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª Streamlit-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è ML-–º–æ–¥–µ–ª–µ–π.
–ó–∞–ø—É—Å–∫:
    streamlit run app.py
"""
from typing import Optional, Dict, Any
import streamlit as st
import pandas as pd
import numpy as np
import io
import os
import joblib
import sys

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –º–æ–¥—É–ª—è–º
sys.path.append(os.path.dirname(__file__))

from modules.data_loader import load_data_interface
from modules.data_explorer import explore_data_interface
from modules.data_preprocessor import preprocess_interface, save_preprocessing_pipeline
from modules.model_trainer import train_model_interface, save_model_bytes
from modules.metrics_visualizer import visualize_metrics_interface

st.set_page_config(
    page_title="Data Analysis & ML Studio",
    layout="wide",
    page_icon="üìä",
    initial_sidebar_state="expanded"
)

APP_TITLE = "Data Analysis & Machine Learning Studio"

def init_session_state():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
    defaults = {
        "df": None,
        "processed_df": None,
        "pipeline": None,
        "model": None,
        "train_results": None,
        "data_loaded": False,
        "data_processed": False,
        "model_trained": False,
        "current_page": "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"
    }

    for key, value in defaults.items():
        if key not in st.session_state:
            st.session_state[key] = value

def show_sidebar_navigation():
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ —Å–∞–π–¥–±–∞—Ä–µ"""
    st.sidebar.title("üìä –ù–∞–≤–∏–≥–∞—Ü–∏—è")

    # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    st.sidebar.markdown("### –ü—Ä–æ–≥—Ä–µ—Å—Å")

    # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞
    status_emoji = {
        True: "‚úÖ",
        False: "‚ùå"
    }

    st.sidebar.markdown(f"{status_emoji[st.session_state.data_loaded]} –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
    st.sidebar.markdown(f"{status_emoji[st.session_state.data_processed]} –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞")
    st.sidebar.markdown(f"{status_emoji[st.session_state.model_trained]} –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏")

    st.sidebar.markdown("---")

    # –ù–∞–≤–∏–≥–∞—Ü–∏—è
    pages = [
        ("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö", "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"),
        ("üîç –†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑", "–†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑"),
        ("‚öôÔ∏è –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞", "–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞"),
        ("üß† –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏", "–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏"),
        ("üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫", "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫"),
        ("‚ùì –°–ø—Ä–∞–≤–∫–∞/README", "–°–ø—Ä–∞–≤–∫–∞/README")
    ]

    current_page = st.sidebar.radio("–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª—å",
                                    [page[0] for page in pages],
                                    index=0)

    # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∏–º—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    for display_name, page_name in pages:
        if display_name == current_page:
            return page_name

    return "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"

def show_data_info():
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∞–π–¥–±–∞—Ä–µ"""
    if st.session_state.df is not None:
        st.sidebar.markdown("---")
        st.sidebar.markdown("### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö")
        st.sidebar.write(f"üìè –†–∞–∑–º–µ—Ä: {st.session_state.df.shape[0]} —Å—Ç—Ä–æ–∫, {st.session_state.df.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤")

        if st.session_state.processed_df is not None:
            st.sidebar.write(f"‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {st.session_state.processed_df.shape[0]} —Å—Ç—Ä–æ–∫, {st.session_state.processed_df.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤")

def show_quick_actions():
    """–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Å–∞–π–¥–±–∞—Ä–µ"""
    st.sidebar.markdown("---")
    st.sidebar.markdown("### –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è")

    if st.session_state.df is not None:
        if st.sidebar.button("üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ", use_container_width=True):
            reset_session_state()
            st.rerun()

        # –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
        if st.sidebar.button("üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö", use_container_width=True):
            st.session_state.show_data_preview = True

def reset_session_state():
    """–°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
    keys_to_keep = ['current_page']
    backup = {k: st.session_state[k] for k in keys_to_keep if k in st.session_state}

    st.session_state.clear()

    for k, v in backup.items():
        st.session_state[k] = v

def show_welcome_page():
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
    st.markdown(f"""
    <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
         #<h1 style="font-size: 3rem; margin-bottom: 1rem;">{APP_TITLE}</h1>
        <p style="font-size: 1.2rem;"> –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
    </div>
    """, unsafe_allow_html=True)

    st.markdown("---")

    # –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
    col1, col2, col3 = st.columns(3)

    with col1:
        st.markdown("### üì• 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
        st.markdown("""
        - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ CSV, Excel —Ñ–∞–π–ª–æ–≤
        - –ê–≤—Ç–æ–¥–µ—Ç–µ–∫—Ü–∏—è –∫–æ–¥–∏—Ä–æ–≤–æ–∫ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π  
        - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
        - –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
        """)

    with col2:
        st.markdown("### üîç 2. –ê–Ω–∞–ª–∏–∑ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞")
        st.markdown("""
        - –†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
        - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
        - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –∏ –≤—ã–±—Ä–æ—Å–æ–≤
        - Feature engineering
        """)

    with col3:
        st.markdown("### üß† 3. ML –º–æ–¥–µ–ª–∏")
        st.markdown("""
        - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
        - –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        - –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
        - –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–µ–π
        """)

    st.markdown("---")

    # –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    st.markdown("### üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç")

    example_col1, example_col2 = st.columns([2, 1])

    with example_col1:
        st.markdown("""
        1. **–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ** —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö'
        2. **–ò—Å—Å–ª–µ–¥—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ** –≤ –º–æ–¥—É–ª–µ '–†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑'  
        3. **–û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ** –≤ –º–æ–¥—É–ª–µ '–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞'
        4. **–û–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª—å** –≤ –º–æ–¥—É–ª–µ '–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏'
        5. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** –≤ –º–æ–¥—É–ª–µ '–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫'
        """)

    with example_col2:
        st.info("üí° **–°–æ–≤–µ—Ç**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏")

def show_data_preview():
    """–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö"""
    if st.session_state.get('show_data_preview', False):
        st.sidebar.markdown("---")
        st.sidebar.markdown("### –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö")

        if st.session_state.df is not None:
            st.sidebar.dataframe(st.session_state.df.head(10), use_container_width=True)

            if st.sidebar.button("–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä", use_container_width=True):
                st.session_state.show_data_preview = False
                st.rerun()

def main() -> None:
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    init_session_state()

    # –ù–∞–≤–∏–≥–∞—Ü–∏—è
    page = show_sidebar_navigation()

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö
    show_data_info()

    # –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    show_quick_actions()

    # –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
    show_data_preview()

    # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
    try:
        if page == "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö":
            st.header("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
            df = load_data_interface()
            if df is not None:
                st.session_state.df = df
                st.session_state.data_loaded = True
                st.success(f"‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –†–∞–∑–º–µ—Ä: {df.shape[0]} —Å—Ç—Ä–æ–∫, {df.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤")

                # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if st.button("üíæ –°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (CSV)"):
                    buf = io.BytesIO()
                    df.to_csv(buf, index=False, encoding='utf-8')
                    buf.seek(0)
                    st.download_button(
                        label="–°–∫–∞—á–∞—Ç—å CSV",
                        data=buf,
                        file_name="original_data.csv",
                        mime="text/csv"
                    )

        elif page == "–†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑":
            st.header("üîç –†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö")
            if st.session_state.df is None:
                st.error("‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")
                st.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–¥–µ–ª–µ '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö'")
                if st.button("üì• –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö"):
                    st.session_state.current_page = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"
                    st.rerun()
            else:
                explore_data_interface(st.session_state.df)

        elif page == "–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞":
            st.header("‚öôÔ∏è –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
            if st.session_state.df is None:
                st.error("‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")
                st.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–¥–µ–ª–µ '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö'")
            else:
                # –í—ã–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                data_source = st.radio(
                    "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:",
                    ["–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", "–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"],
                    horizontal=True
                )

                if data_source == "–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ":
                    input_df = st.session_state.df
                else:
                    input_df = st.session_state.processed_df if st.session_state.processed_df is not None else st.session_state.df

                processed_df, pipeline = preprocess_interface(input_df)

                if processed_df is not None:
                    st.session_state.processed_df = processed_df
                    st.session_state.pipeline = pipeline
                    st.session_state.data_processed = True

                    st.success(f"‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã! –ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä: {processed_df.shape[0]} —Å—Ç—Ä–æ–∫, {processed_df.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤")

                    # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    col1, col2 = st.columns(2)

                    with col1:
                        buf_csv = io.BytesIO()
                        processed_df.to_csv(buf_csv, index=False, encoding='utf-8')
                        buf_csv.seek(0)
                        st.download_button(
                            "üíæ –°–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (CSV)",
                            data=buf_csv,
                            file_name="processed_data.csv",
                            mime="text/csv",
                            use_container_width=True
                        )

                    with col2:
                        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ pipeline
                        if pipeline is not None:
                            try:
                                pipeline_path = save_preprocessing_pipeline(pipeline, "preprocessing_pipeline.joblib")
                                if pipeline_path and os.path.exists(pipeline_path):
                                    with open(pipeline_path, "rb") as f:
                                        st.download_button(
                                            "üîß –°–∫–∞—á–∞—Ç—å pipeline –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏",
                                            data=f,
                                            file_name="preprocessing_pipeline.joblib",
                                            mime="application/octet-stream",
                                            use_container_width=True
                                        )
                                else:
                                    st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å pipeline")
                            except Exception as e:
                                st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ pipeline: {e}")

        elif page == "–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏":
            st.header("üß† –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏")

            # –í—ã–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
            if st.session_state.processed_df is not None:
                st.success("‚úÖ –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
                train_df = st.session_state.processed_df
            elif st.session_state.df is not None:
                st.warning("‚ö†Ô∏è –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫—É)")
                train_df = st.session_state.df
            else:
                st.error("‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")
                st.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–¥–µ–ª–µ '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö'")
                return

            model, results = train_model_interface(train_df)

            if model is not None and results is not None:
                st.session_state.model = model
                st.session_state.train_results = results
                st.session_state.model_trained = True

                st.balloons()
                st.success("‚úÖ –ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±—É—á–µ–Ω–∞!")

                # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
                model_bytes = save_model_bytes(model)
                st.download_button(
                    "üíæ –°–∫–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å",
                    data=model_bytes,
                    file_name=f"trained_model_{results.get('problem_type', 'model')}.joblib",
                    mime="application/octet-stream",
                    use_container_width=True
                )

        elif page == "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫":
            st.header("üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫")
            if st.session_state.train_results is None:
                st.error("‚ùå –ú–æ–¥–µ–ª—å –Ω–µ –æ–±—É—á–µ–Ω–∞!")
                st.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –æ–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª—å –≤ —Ä–∞–∑–¥–µ–ª–µ '–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏'")
            else:
                visualize_metrics_interface(st.session_state.train_results)

        elif page == "–°–ø—Ä–∞–≤–∫–∞/README":
            st.header("‚ùì –°–ø—Ä–∞–≤–∫–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è")

            # –¢–∞–±—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ —Å–ø—Ä–∞–≤–∫–∏
            tab1, tab2, tab3, tab4 = st.tabs(["üìñ –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ", "üîß –ú–æ–¥—É–ª–∏", "üöÄ –°–æ–≤–µ—Ç—ã", "üìö –ü—Ä–∏–º–µ—Ä—ã"])

            with tab1:
                st.markdown("""
                ### Data Analysis & Machine Learning Studio
                
                **–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è ML-–º–æ–¥–µ–ª–µ–π**
                
                #### üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
                - **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: CSV, Excel —Å –∞–≤—Ç–æ–¥–µ—Ç–µ–∫—Ü–∏–µ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                - **–†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑**: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
                - **–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–æ–≤, –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
                - **ML –º–æ–¥–µ–ª–∏**: —Ä–µ–≥—Ä–µ—Å—Å–∏—è –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π
                - **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è**: –º–µ—Ç—Ä–∏–∫–∏, –≥—Ä–∞—Ñ–∏–∫–∏, –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                
                #### üìä –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∑–∞–¥–∞—á–∏:
                - **–†–µ–≥—Ä–µ—Å—Å–∏—è**: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                - **–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è**: –±–∏–Ω–∞—Ä–Ω–∞—è –∏ –º–Ω–æ–≥–æ–∫–ª–∞—Å—Å–æ–≤–∞—è
                """)

            with tab2:
                st.markdown("""
                ### –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π
                
                #### üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤: CSV, Excel (xlsx, xls)
                - –ê–≤—Ç–æ–¥–µ—Ç–µ–∫—Ü–∏—è –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
                - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
                - –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
                
                #### üîç –†–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑
                - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º
                - –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤
                - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
                - –ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π
                
                #### ‚öôÔ∏è –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞
                - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                - –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
                - –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
                - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–æ—Å–æ–≤
                - Feature engineering
                
                #### üß† –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
                - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
                - –ü–æ–¥–±–æ—Ä –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                - –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
                - –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–µ–π
                
                #### üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫
                - –ì—Ä–∞—Ñ–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è
                - –ú–∞—Ç—Ä–∏—Ü—ã –æ—à–∏–±–æ–∫
                - –í–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
                - –ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
                """)

            with tab3:
                st.markdown("""
                ### üöÄ –°–æ–≤–µ—Ç—ã –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
                
                #### üíæ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CSV —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º-–∑–∞–ø—è—Ç–æ–π –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–æ–¥–∏—Ä–æ–≤–∫—É —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–æ–±—ã—á–Ω–æ utf-8 –∏–ª–∏ cp1251)
                - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ
                
                #### üîç –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
                - –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–ª–µ–≤–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
                - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                - –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏
                
                #### ‚öôÔ∏è –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞
                - –í—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ–±—É—á–µ–Ω–∏–µ–º
                - –î–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
                - –î–ª—è tree-based –º–æ–¥–µ–ª–µ–π –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
                - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ One-Hot Encoding –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Å –º–∞–ª—ã–º —á–∏—Å–ª–æ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                
                #### üß† –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
                - –ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Å—Ç—ã—Ö –º–æ–¥–µ–ª–µ–π (Linear Regression, Logistic Regression)
                - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
                - –°—Ä–∞–≤–Ω–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏
                - –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ–º (–±–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É train –∏ test –º–µ—Ç—Ä–∏–∫–∞–º–∏)
                """)

            with tab4:
                st.markdown("""
                ### üìö –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                
                #### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ü–µ–Ω –Ω–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
                1. **–ó–∞–≥—Ä—É–∑–∫–∞**: CSV —Ñ–∞–π–ª —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ –¥–æ–º–æ–≤
                2. **–ê–Ω–∞–ª–∏–∑**: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
                3. **–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞**: –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤, –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–æ–≤
                4. **–û–±—É—á–µ–Ω–∏–µ**: Random Forest –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
                5. **–û—Ü–µ–Ω–∫–∞**: –∞–Ω–∞–ª–∏–∑ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
                
                #### –ü—Ä–∏–º–µ—Ä 2: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
                1. **–ó–∞–≥—Ä—É–∑–∫–∞**: –¥–∞–Ω–Ω—ã–µ –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö –±–∞–Ω–∫–∞
                2. **–ê–Ω–∞–ª–∏–∑**: –±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤, –≤—ã–±—Ä–æ—Å—ã –≤ –≤–æ–∑—Ä–∞—Å—Ç–µ/–¥–æ—Ö–æ–¥–∞—Ö
                3. **–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞**: –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∫–ª–∞—Å—Å–æ–≤, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
                4. **–û–±—É—á–µ–Ω–∏–µ**: Gradient Boosting –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
                5. **–û—Ü–µ–Ω–∫–∞**: –º–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫, precision-recall –∫—Ä–∏–≤—ã–µ
                
                #### –ü—Ä–∏–º–µ—Ä 3: –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
                1. **–ó–∞–≥—Ä—É–∑–∫–∞**: –ø—Ä–æ–¥–∞–∂–∏ –ø–æ –¥–Ω—è–º/–º–µ—Å—è—Ü–∞–º
                2. **–ê–Ω–∞–ª–∏–∑**: —Ç—Ä–µ–Ω–¥—ã, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å, –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è
                3. **–ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞**: —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∞–≥–æ–≤, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–∞—Ç—ã
                4. **–û–±—É—á–µ–Ω–∏–µ**: —Ä–µ–≥—Ä–µ—Å—Å–∏—è —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏
                5. **–û—Ü–µ–Ω–∫–∞**: –∞–Ω–∞–ª–∏–∑ –æ—Å—Ç–∞—Ç–∫–æ–≤, –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ
                """)

        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        if (page == "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö" and st.session_state.df is None and
                not st.session_state.get('welcome_shown', False)):
            show_welcome_page()
            st.session_state.welcome_shown = True

    except Exception as e:
        st.error(f"‚ùå –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: {e}")
        st.exception(e)

        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞
        if st.button("üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"):
            reset_session_state()
            st.rerun()


if __name__ == "__main__":
    main()
